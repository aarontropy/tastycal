<!DOCTYPE html>
<html>
<head>
<link href='http://cdnjs.cloudflare.com/ajax/libs/fullcalendar/1.6.4/fullcalendar.css' rel='stylesheet' />
<link href='http://cdnjs.cloudflare.com/ajax/libs/fullcalendar/1.6.4/fullcalendar.print.css' rel='stylesheet' media='print' />
<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet" type="text/css" />
<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.0/themes/base/jquery-ui.css" rel="stylesheet" type="text/css" />
<link href="/static/css/bootstrap-switch.css" rel="stylesheet" type="text/css" />


<script src='http://code.jquery.com/jquery-1.9.1.js'></script>
<script src='http://code.jquery.com/ui/1.10.3/jquery-ui.js'></script>
<script src='http://cdnjs.cloudflare.com/ajax/libs/fullcalendar/1.6.4/fullcalendar.min.js'></script>
<script src='http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js'></script>
<script src='/static/js/jquery-ui-timepicker-addon.js'></script>
<script src='/static/js/jquery-serializeobject.js'></script>
<script src='/static/js/moment.min.js'></script>
<script src='/static/js/underscore-min.js'></script>
<script src='/static/js/rrule.js'></script>
<script>

	var freqs = ["YEARLY","MONTHLY","WEEKLY","DAILY","HOURLY","MINUTELY","SECONDLY"]


	//--- CSRF STUFF -----------------------------------------------------------
	function getCookie(name) {
    	var cookieValue = null;
	    if (document.cookie && document.cookie != '') {
	        var cookies = document.cookie.split(';');
	        for (var i = 0; i < cookies.length; i++) {
	            var cookie = jQuery.trim(cookies[i]);
	            // Does this cookie string begin with the name we want?
	            if (cookie.substring(0, name.length + 1) == (name + '=')) {
	                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
	                break;
	            }
	        }
	    }
	    return cookieValue;
	}
	var csrftoken = getCookie('csrftoken');

	function csrfSafeMethod(method) {
	    // these HTTP methods do not require CSRF protection
	    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
	}
	function sameOrigin(url) {
	    // test that a given url is a same-origin URL
	    // url could be relative or scheme relative or absolute
	    var host = document.location.host; // host + port
	    var protocol = document.location.protocol;
	    var sr_origin = '//' + host;
	    var origin = protocol + sr_origin;
	    // Allow absolute or scheme relative URLs to same origin
	    return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
	        (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
	        // or any other URL that isn't scheme relative or absolute i.e relative.
	        !(/^(\/\/|http:|https:).*/.test(url));
	}
	$.ajaxSetup({
	    beforeSend: function(xhr, settings) {
	        if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
	            // Send the token to same-origin, relative URLs only.
	            // Send the token only if the method warrants CSRF protection
	            // Using the CSRFToken value acquired earlier
	            xhr.setRequestHeader("X-CSRFToken", csrftoken);
	        }
	    }
	});


	function set_repeat_section_visibility() {
		var is_repeat = $('#event_repeat').is(':checked')

		if (is_repeat) {
			$('#repeat_section').removeClass('hide');
		} else {
			$('#repeat_section').addClass('hide');
		}
	}

	function calendar_api(url, type, data) {
		console.log(url);
		$.ajax({
			url: url,
			type: type,
			contentType: 'application/json',
			data: data,
			dataType: 'json',
			processData: false,

		}).done(function() { 
	    	calendar.fullCalendar('refetchEvents');
		}).fail(function(xhr, textStatus, errorThrown) { 
			console.log(jQuery.parseJSON( xhr.responseText ));
			alert('Error in saving event');
	    }).always(function() { 
	    	// Do something always
	    });
	}


	function set_up_forms(event) {

		$('#event_tite').val(event.title);
		$('#event_start').val( moment(event.start).format('MM/DD/YYYY h:mm a') );
		$('#event_end').val( event.end ? moment(event.end).format('MM/DD/YYYY h:mm a') : "" );
		$('#event_id').val(event.id);
		$('#event_uri').val(event.resource_uri);
		$('#event_modal_delete').removeClass("hide") 
		$('#event_repeat').prop('checked', event.rule != null); 
		$('#updated_rule').val("");
		if (event.rule != null) {
			$('#edit_repeat').removeClass('hide');
			$('#' + freqs[event.rule.freq]).addClass('active');
			// $.each('#byweekday-group .btn')
		} else {
			$('#edit_repeat').addClass('hide');
		}


	}

	var calendar_list = []
	var calendar_current = {}

	$(document).ready(function() {

		//--- CALENDAR LIST  ---------------------------------------------------
		$.ajax({
			url: "{% url 'api_dispatch_list' resource_name='calendar' api_name='v1' %}",
			type: "GET",
			contentType: 'application/json'
		})
		.done(function(data) {
			calendar_list = data.calendars;
			var cal_select = $('#calendar_list');
			cal_select.empty();
			cal_select.append(new Option('-- Select Calendar --', '', true, true));

			$.each(data.calendars, function(index, cal) {
				cal_select.append( new Option(cal.title, index))
			})
		})

		$('#calendar_list').on('change', function(ev) {
			val = $(this).val();
			if ($.isNumeric( val )) {
				if (calendar_current.hasOwnProperty('events_uri') ) {
					// alert("Removing " + calendar_current.events_uri);
					calendar.fullCalendar('removeEventSource', calendar_current.events_uri );
				}

				calendar_current = calendar_list[val];
				var eventSource = {
					url: calendar_current.events_uri
				}

				calendar.fullCalendar('addEventSource', eventSource);
				calendar.fullCalendar('removeEvents');
				calendar.fullCalendar('refetchEvents');
			}

		});


		var cal_data = {
			occurrence_list_uri: '/api/v1/occurrence/',
			default_cal: {
				occurrence_list_uri: '/api/v1/event/1/occurrences/',
				event_uri: '/api/v1/event/1/',
				event_id: 1
			}
		};
	
		var calendar = $('#calendar').fullCalendar({
		
			editable: true,
			selectable: true,
			selectHelper: true,

			// Two things:
			// 1)	Tastypie defaults to <field>__exact=<value> when only the field
			//  	name is passed. Adding the type of filter prevents this.
			// 2)	We want all events where start is shown in this view, so change
			//		the endParam to 'start' as well
			startParam: 'start__gte',
			endParam: 'start__lte',

			eventSources: [],
			
			eventDrop: function(event, dayDelta, minuteDelta, allDay, revertFunc, jsEvent) {
				var minutesDiff = (dayDelta * 60 * 24) + minuteDelta
				var data = JSON.stringify({
				    "start": event.start, //new Date(event.start.getTime() + (minutesDiff * 60000)),
				    "end": event.end, //new Date(event.end.getTime() + (minutesDiff * 60000)),
				    "id": event.id
				});

				$.ajax({
					url: event.resource_uri,
					type: 'PATCH',
					contentType: 'application/json',
					data: data,
					dataType: 'text',
					processData: false
				})
				.done(function() { })
			    .fail(function(xhr, textStatus, errorThrown) { 
			    	alert("There was a problem on the server...wonder what it was...");
			    }).always(function() { });
			},

			select: function(start, end, allDay) {
				set_up_forms({start: start, end: end, title: "Class"});
				$('#event_modal').modal('show');

				calendar.fullCalendar('unselect');
			},
			eventClick: function( event, jsEvent, view ) {
				set_up_forms(event);
				$('#event_modal').modal('show');
			},

			loading: function(bool) {
				if (bool) $('#loading').show();
				else $('#loading').hide();
			},
			eventDataTransform: function( eventData ) {
				return eventData;
			}

			
		});

		//--- MODAL  -----------------------------------------------------------
		$('#event_modal').modal({ 
			show: false,
			keyboard: true,
		});


		//--- MODAL REPEAT SECTION  ------------------------------------------------
		$('#event_repeat').on('change', function() {
			set_repeat_section_visibility();
		})



		//----------------------------------------------------------------------
		//--- EVENT SAVE BUTTON  -----------------------------------------------
		$('#event_modal_save').on('click', function(e){
			var byweekday = []
			$('#byweekday-group .btn.active').each(function() {
				byweekday.push( eval(this.id) );
			})

			// The various jquery serializeObject techniques for forms don't 
			// grab the data from the bootstrap button groups, so we do it
			// this way
			data_obj = {
				title: $('#event_title').val(),
				start: new Date($('#event_start').val()),
				end: new Date($('#event_end').val()),
				repeating: $('#event_repeat').is(':checked'),
				calendar: calendar_current.resource_uri,
				freq: freqs.indexOf($('#freq-group .btn.active').attr('id')),
			    until: new Date($('#event_until').val()),
			    count: $('#event_count').val(),
			    byweekday: byweekday,
			}
			data = JSON.stringify(data_obj);

			if ($('#event_id').val() == "") {
				// new event
				url = calendar_current.events_uri;
				type = "POST";
			} else {
				// update existing
				url = $('#event_uri').val();
				type = "PATCH";
			}
			
			console.log(data_obj);
			$.ajax({
				url: url,
				type: type,
				contentType: 'application/json',
				data: data,
				dataType: 'text',
				processData: false,

			}).done(function() { 
		    	calendar.fullCalendar('refetchEvents');
			}).fail(function(xhr, textStatus, errorThrown) { 
				console.log(jQuery.parseJSON( xhr.responseText ));
				alert('Error in saving event');
		    }).always(function() { 
		    	// Do something always
		    });

		    $('#event_modal').modal('hide')

		});

		//----------------------------------------------------------------------
		//--- REPEAT CHECKBOX --------------------------------------------------
		$('#event_repeat').on('change', function() {
			// If repeat is clicked and this event does not already have a rule 
			// associated with it, open the repeat form
			var existing_rule = $('#rule_id').val() != ""
			var repeating = $('#event_repeat').is(':checked')
			if (repeating && !existing_rule) {
				$('#event_modal').modal('hide');
				$('#repeat_modal').modal('show');

			// If repeat is clicked and there is already a rule associated with
			// the event, re-show the edit link
			} else if (repeating && existing_rule) {

			}
		});

		//----------------------------------------------------------------------
		//--- MODAL REPEAT CANCEL  ---------------------------------------------
		$('#repeat_modal_cancel').on('click', function() {
			$('#repeat_modal').modal('hide');
			$('#event_modal').modal('show');
			$('#updated_rule').val("");
			// If the user is cancelling and there was no previous repeat rule
			// saved, make sure that the repeat checkbox is off
			if ($('#rule_id').val() == "") {
				$('#event_repeat').prop('checked', false);
			}
		});


		//----------------------------------------------------------------------
		//--- MODAL REPEAT SAVE BUTTON  ----------------------------------------
		$('#repeat_modal_save').on('click', function(e) {
			$('#repeat_modal').modal('hide');
			$('#event_modal').modal('show');
			// $('#updated_rule').val("XXX");
		});
			


		//----------------------------------------------------------------------
		//--- MODAL DELETE BUTTON  ---------------------------------------------
		$('#event_modal_delete').on('click', function(e) {
			$.ajax({
				url: $('#event_uri').val(),
				type: 'DELETE',
				contentType: 'application/json',
				dataType: 'text',
				processData: true

			}).done(function() { 
		    	calendar.fullCalendar('refetchEvents');
			}).fail(function(xhr, textStatus, errorThrown) { 
		    	alert("There was a problem on the server...wonder what it was...");
		    	console.log(xhr);
		    }).always(function() { 
		    	// Do something always
		    });
	    	$('#event_modal').modal('hide')
		    calendar.fullCalendar('refetchEvents');
		})

		//--- DATE/TIME PICKER ------------------------------------
		$('#event_start, #event_end, #event_until').datetimepicker({
	      timeFormat: 'hh:mm tt',
	      stepMinute: 15,
	    });
		
	});

</script>
<style>

	body {
		margin-top: 40px;
		font-size: 14px;
		font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
		}
		
	#calendar_container {
		text-align: center;
		}

	#loading {
		position: absolute;
		top: 5px;
		right: 5px;
		}

	#calendar {
		width: 900px;
		margin: 0 auto;
		}

</style>
</head>
<body>
	<select id="calendar_list"></select>
	<ul>
		<li><a href="{% url 'api_dispatch_list' resource_name='calendar' api_name='v1' %}">Calendar API</a></li>
	</ul>

	<div id="calendar_container">
		<div id='loading' style='display:none'>loading...</div>
		<div id='calendar'></div>
	</div>

<form id="event_modal_form" class="form-horizontal">

<div id="event_modal" class="modal hide fade">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal">×</button>
		<h3 id="event_modal_header">New Event</h3>
	</div>
	<div class="modal-body" style="max-height: 800px;">
			<!-- SINGLE EVENT SECTION -->
			<input type="hidden" id="event_id" name="id" value="" />
			<input type="hidden" id="event_uri" name="uri" value="" />
			<input type="hidden" id="rule_id" name="rule_id" value="" />
			<input type="hidden" id="rule_uri" name="rule_uri" value="" />
			<input type="hidden" id="updated_rule" value="" />

			<div class="control-group">
				<label class="control-label" for="title">Title</label>
				<div class="controls"><input type="text" id="event_title" name="title" value="Class" /></div>
			</div>
			<div class="control-group">
				<label class="control-label" for="start">Start</label>
				<div class="controls"><input type="text" id="event_start" name="start" placeholder="Click…" /></div>
			</div>
			<div class="control-group">
				<label class="control-label" for="end">End</label>
				<div class="controls"><input type="text" id="event_end" name="end" placeholder="Click…"/></div>
			</div>
			<div class="control-group">
				<div class="controls form-inline">
					<input type="checkbox" id="event_all_day" name="all_day" /><label for="event_all_day">All Day</label>
					<input type="checkbox" id="event_repeat" name="repeat" /><label for="event_repeat">Repeat</label><button class="btn btn-info btn-mini" id="edit_repeat">Edit</button>
				</div>
			</div>
	</div>
	<div class="modal-footer">
	    <button type="button" class="btn" data-dismiss="modal">Close</button>
	    <button type="button" class="btn btn-primary" id="event_modal_save">Save changes</button>
	    <button type="button" class="btn btn-danger hide" id="event_modal_delete">Delete</button>
	</div>
</div>

<div id="repeat_modal" class="modal hide fade">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal">×</button>
		<h3>Repeat</h3>
	</div>
	<div class="modal-body" style="max-height: 800px;">
			<!-- RECURRING EVENT SECTION -->
			<div class="hide" id="repeat_section">
				<div class="control-group">
					<label class="control-label" for="freq">Repeat every</label>
					<div class="controls">
						<div id="freq-group" class="btn-group" data-toggle="buttons-radio">
							<button type="button" id="DAILY" class="btn btn-primary">Daily</button>
							<button type="button" id="WEEKLY" class="btn btn-primary active">Weekly</button>
							<button type="button" id="MONTHLY" class="btn btn-primary">Monthly</button>
						</div>
					</div>
				</div>

				<div class="control-group">
					<label class="control-label" for="byweekday">On days</label>
					<div class="controls">
						<div id="byweekday-group" class="btn-group" data-toggle="buttons-checkbox">
							<button type="button" id="RRule.SU" class="btn btn-mini btn-primary">Sun</button>
							<button type="button" id="RRule.MO" class="btn btn-mini btn-primary">Mon</button>
							<button type="button" id="RRule.TU" class="btn btn-mini btn-primary">Tue</button>
							<button type="button" id="RRule.WE" class="btn btn-mini btn-primary">Wed</button>
							<button type="button" id="RRule.TH" class="btn btn-mini btn-primary">Thu</button>
							<button type="button" id="RRule.FR" class="btn btn-mini btn-primary">Fri</button>
							<button type="button" id="RRule.SA" class="btn btn-mini btn-primary">Sat</button>
						</div>
					</div>
				</div>

				<div class="control-group">
					<label class="control-label" for="count">Count</label>
					<div class="controls"><input type="text" id="event_count" name="count" placeholder="# of classes" /></div>
				</div>
				<div class="control-group">
					<label class="control-label" for="until">Until</label>
				 	<div class="controls"><input type="text" id="event_until" name="until" placeholder="Click…" /></div>
				</div>
			</div>


	<div class="model-footer">
	    <button type="button" class="btn" id="repeat_modal_cancel">Close</button>
	    <button type="button" class="btn btn-primary" id="repeat_modal_save">Save changes</button>
	    <button type="button" class="btn btn-danger hide" id="repeat_modal_delete">Delete</button>
	</div>
</div>
		
</form>


</body>
</html>